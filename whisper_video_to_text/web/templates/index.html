<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whisper Video → Text</title>
  <link rel="stylesheet" href="/static/style.css" />
  <style>
    /* Fallback minimal styles if static not served */
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    header { margin-bottom: 1rem; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; max-width: 720px; }
    label { display: block; margin: .5rem 0 .25rem; font-weight: 600; }
    input[type="text"], select { width: 100%; padding: .5rem; border: 1px solid #d1d5db; border-radius: 6px; }
    .row { display: flex; gap: 1rem; align-items: center; }
    .row > * { flex: 1; }
    .btn { background: #111827; color: #fff; border: none; padding: .6rem 1rem; border-radius: 6px; cursor: pointer; }
    .muted { color: #6b7280; font-size: .9rem; }
    .progress { height: 10px; background: #e5e7eb; border-radius: 6px; overflow: hidden; margin-top: .5rem; }
    .bar { height: 100%; width: 0%; background: #2563eb; transition: width .2s ease; }
    pre { white-space: pre-wrap; background: #0b1020; color: #e5e7eb; padding: 1rem; border-radius: 6px; }
  </style>
  <script>
    async function startJob(e) {
      e.preventDefault();
      const form = document.getElementById('form');
      const data = new FormData(form);
      // Ensure at least one of file or url provided
      if (!data.get('file') && !data.get('url')) {
        alert('Please choose a file or provide a URL.');
        return;
      }
      const res = await fetch('/api/transcribe', { method: 'POST', body: data });
      const { job_id } = await res.json();
      listen(job_id);
      document.getElementById('status').textContent = 'Queued…';
    }

    function listen(jobId) {
      const events = new EventSource(`/events/${jobId}`);
      const bar = document.getElementById('bar');
      const status = document.getElementById('status');
      const message = document.getElementById('message');
      const output = document.getElementById('output');
      events.onmessage = (ev) => {
        const data = JSON.parse(ev.data);
        bar.style.width = (data.progress || 0) + '%';
        status.textContent = data.status || '';
        message.textContent = data.message || '';
        if (data.result && data.result.text) {
          output.textContent = data.result.text;
        }
        if (data.status === 'complete' || data.status === 'error') {
          events.close();
        }
      };
    }
  </script>
  </head>
  <body>
    <header>
      <h1>Whisper Video → Text</h1>
      <p class="muted">Local Whisper transcription with YouTube download support.</p>
    </header>
    <main>
      <section class="card">
        <form id="form" onsubmit="startJob(event)">
          <label for="file">Upload MP4</label>
          <input id="file" name="file" type="file" accept="video/mp4" />

          <div style="text-align:center; margin: .5rem 0;" class="muted">— or —</div>

          <label for="url">YouTube URL</label>
          <input id="url" name="url" type="text" placeholder="https://youtube.com/watch?v=..." />

          <div class="row">
            <div>
              <label for="model">Model</label>
              <select id="model" name="model">
                <option value="tiny">tiny</option>
                <option value="base" selected>base</option>
                <option value="small">small</option>
                <option value="medium">medium</option>
                <option value="large">large</option>
              </select>
            </div>
            <div>
              <label for="language">Language (optional)</label>
              <input id="language" name="language" type="text" placeholder="en" />
            </div>
          </div>

          <div class="row" style="align-items:center;">
            <label><input type="checkbox" name="timestamps" /> Include timestamps</label>
            <span class="muted">Formats default to txt</span>
          </div>

          <button class="btn" type="submit">Start Transcription</button>
          <div class="progress"><div id="bar" class="bar"></div></div>
          <div class="muted"><strong id="status"></strong> <span id="message"></span></div>
        </form>
      </section>

      <section class="card" style="margin-top:1rem;">
        <h3>Output</h3>
        <pre id="output">Waiting for results…</pre>
      </section>
    </main>
  </body>
  </html>
