<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Whisper Video → Text</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="/static/style.css" />


  <script>
    // Theme initialization
    (function () {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
        document.documentElement.setAttribute('data-theme', 'light');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
      }
    })();

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const target = current === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', target);
      localStorage.setItem('theme', target);

      // Update button text
      const btn = document.getElementById('theme-btn');
      if (btn) btn.innerText = target === 'light' ? 'NIGHT MODE' : 'DAY MODE';
    }

    async function startJob(e) {
      e.preventDefault();
      const form = document.getElementById('form');
      const data = new FormData(form);
      // Ensure at least one of file or url provided
      if (!data.get('file') && !data.get('url')) {
        alert('Please choose a file or provide a URL.');
        return;
      }

      const btn = document.querySelector('button[type="submit"]');
      const originalText = btn.innerText;
      btn.innerText = "INITIALIZING...";
      btn.disabled = true;

      try {
        const res = await fetch('/api/transcribe', { method: 'POST', body: data });
        if (!res.ok) throw new Error('Request failed');
        const { job_id } = await res.json();

        btn.innerText = "PROCESSING...";
        listen(job_id);

        document.getElementById('status-container').style.display = 'block';
        document.getElementById('status').textContent = 'QUEUED';
        document.getElementById('status').style.color = 'var(--text-meta)';
      } catch (err) {
        btn.innerText = originalText;
        btn.disabled = false;
        alert('Error starting transcription: ' + err.message);
      }
    }

    function listen(jobId) {
      const events = new EventSource(`/events/${jobId}`);
      const bar = document.getElementById('bar');
      const status = document.getElementById('status');
      const message = document.getElementById('message');
      const output = document.getElementById('output');
      const btn = document.querySelector('button[type="submit"]');

      events.onmessage = (ev) => {
        const data = JSON.parse(ev.data);
        bar.style.width = (data.progress || 0) + '%';

        if (data.status) {
          status.textContent = data.status.toUpperCase();
          if (data.status === 'processing') status.style.color = 'var(--accent-yellow)';
          if (data.status === 'complete') status.style.color = 'var(--text-primary)';
          if (data.status === 'error') status.style.color = 'var(--accent-alert)';
        }

        message.textContent = data.message || '';

        if (data.result && data.result.text) {
          output.textContent = data.result.text;
        }

        if (data.status === 'complete' || data.status === 'error') {
          events.close();
          btn.innerText = "START TRANSCRIPTION";
          btn.disabled = false;
        }
      };

      events.onerror = () => {
        events.close();
        btn.innerText = "START TRANSCRIPTION";
        btn.disabled = false;
      }
    }
  </script>
</head>

<body>

  <nav class="nav-bar">
    <div>
      <h3>WHISPER VIDEO → TEXT</h3>
    </div>
    <div class="meta" style="display: flex; align-items: center; gap: 1rem;">
      <button id="theme-btn" class="theme-toggle" onclick="toggleTheme()">DAY MODE</button>
      <span>SYSTEM STATUS: ONLINE</span>
    </div>
  </nav>

  <script>
    // Initialize button text correctly on load
    document.addEventListener('DOMContentLoaded', () => {
      const current = document.documentElement.getAttribute('data-theme');
      const btn = document.getElementById('theme-btn');
      if (btn) btn.innerText = current === 'light' ? 'NIGHT MODE' : 'DAY MODE';
    });
  </script>

  <main class="grid-container">

    <!-- Column 1: Primary System (Inputs) -->
    <div class="grid-item">
      <div class="meta" style="margin-bottom: 1rem;">// 01. INPUT PARAMETERS</div>

      <form id="form" onsubmit="startJob(event)">
        <div class="card">
          <label for="file">SOURCE MP4 FILE</label>
          <input id="file" name="file" type="file" accept="video/mp4" />

          <div class="divider-text">OR</div>

          <label for="url">YOUTUBE URL</label>
          <input id="url" name="url" type="text" placeholder="https://youtube.com/watch?v=..." />
        </div>

        <div class="card">
          <div class="row">
            <div>
              <label for="model">WHISPER MODEL</label>
              <select id="model" name="model">
                <option value="tiny">tiny</option>
                <option value="base" selected>base</option>
                <option value="small">small</option>
                <option value="medium">medium</option>
                <option value="large">large</option>
              </select>
            </div>
            <div>
              <label for="language">LANGUAGE (OPTIONAL)</label>
              <input id="language" name="language" type="text" placeholder="en" />
            </div>
          </div>

          <div style="margin-top: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" name="timestamps" id="timestamps" style="width: auto; margin: 0;">
            <label for="timestamps" style="margin: 0; cursor: pointer;">INCLUDE TIMESTAMPS</label>
          </div>
        </div>

        <button class="btn btn-primary" type="submit">START TRANSCRIPTION</button>
      </form>
    </div>

    <!-- Column 2: Data Output (Status + Logs) -->
    <div class="grid-item" style="border-left: 1px solid var(--border-light);">
      <div class="meta" style="margin-bottom: 1rem;">// 02. DATA OUTPUT</div>

      <!-- Status Section moved here -->
      <div id="status-container" class="card" style="display: none;">
        <label>JOB STATUS</label>
        <div id="status" style="font-size: 1.2rem; font-weight: 500; margin-bottom: 0.5rem;">WAITING</div>
        <div id="message" class="meta" style="margin-bottom: 1rem;">Ready for input...</div>

        <label>PROGRESS</label>
        <div class="progress">
          <div id="bar" class="bar"></div>
        </div>
      </div>

      <!-- Worker info kept small or moved -->
      <div class="card" style="opacity: 0.5; padding: 1rem;">
        <div class="row" style="gap: 2rem;">
          <div class="meta">WORKER: LOCAL_INSTANCE_01</div>
          <div class="meta">DEVICE: CPU/GPU</div>
        </div>
      </div>

      <div class="card" style="height: 100%; display: flex; flex-direction: column;">
        <label>TRANSCRIPT LOG</label>
        <pre id="output" style="flex: 1;">Waiting for data stream...</pre>
      </div>
    </div>

  </main>

</body>

</html>